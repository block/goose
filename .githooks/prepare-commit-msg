#!/usr/bin/env bash
# Auto-add a DCO Signed-off-by footer to commits when missing.
# Install by running: ./scripts/install-git-hooks.sh

set -euo pipefail

MSG_FILE="$1"
COMMIT_SOURCE="${2-}"

# Don't modify merge commits
if [[ "$COMMIT_SOURCE" == "merge" ]]; then
  exit 0
fi

# If Signed-off-by already present, do nothing
if grep -q -i '^Signed-off-by: ' "$MSG_FILE"; then
  exit 0
fi

# Determine author name and email
AUTHOR_NAME="$(git config user.name || true)"
AUTHOR_EMAIL="$(git config user.email || true)"

if [[ -z "$AUTHOR_NAME" || -z "$AUTHOR_EMAIL" ]]; then
  # Fallback to GIT_AUTHOR_IDENT
  if git var GIT_AUTHOR_IDENT >/dev/null 2>&1; then
    GIT_IDENT="$(git var GIT_AUTHOR_IDENT)"
    # GIT_AUTHOR_IDENT format: Name <email> timestamp timezone
    AUTHOR_NAME="${GIT_IDENT%%<*}"
    AUTHOR_EMAIL="$(echo "$GIT_IDENT" | sed -n 's/.*<\(.*\)>.*/\1/p')"
    AUTHOR_NAME="$(echo "$AUTHOR_NAME" | sed 's/[[:space:]]*$//')"
  fi
fi

if [[ -z "$AUTHOR_NAME" || -z "$AUTHOR_EMAIL" ]]; then
  # Can't determine identity; leave message untouched
  exit 0
fi

SIGNED_LINE="Signed-off-by: ${AUTHOR_NAME} <${AUTHOR_EMAIL}>"

# Append a blank line and the Signed-off-by footer
printf "\n%s\n" "$SIGNED_LINE" >> "$MSG_FILE"

exit 0
