---
title: Non-Obvious Knowledge — Goose Desktop UI
updated: 2026-02-17
session: "feature/cli-via-goosed"
commits: "665fd046..ca2f3383"
---

# Non-Obvious Knowledge

Hard-won insights from building the Goose Desktop UI that aren't documented elsewhere.

## Architecture

### OpenAPI Generation Pipeline

The OpenAPI spec generation has a **3-step pipeline** that's easy to break:

1. `cargo run -p goose-server --bin generate_schema` → writes `ui/desktop/openapi.json`
2. `npx @hey-api/openapi-ts` → reads `openapi.json`, generates `sdk.gen.ts`, `types.gen.ts`, `index.ts`
3. **DANGER:** Step 2 **deletes** `src/api/instances.ts` — this is a hand-written file that must be restored via `git checkout HEAD -- ui/desktop/src/api/instances.ts` after every `just generate-openapi`

To register new routes in the OpenAPI spec, you must edit **3 files**:
- `crates/goose/src/lib.rs` — `pub mod <module>;`
- `crates/goose-server/src/routes/mod.rs` — `pub mod <module>;` + `.merge(<module>::routes(state.clone()))`
- `crates/goose-server/src/openapi.rs` — add path handlers to `paths()` + types to `schemas()`

All three must be consistent or the types won't appear in the frontend SDK.

### React Flow v12 Type Compatibility

`@xyflow/react` v12 requires node data types to satisfy `Record<string, unknown>`. Custom interfaces like `DagNodeData` need an **index signature**:

```typescript
export interface DagNodeData {
  kind: NodeKind;
  label: string;
  // ... other fields
  [key: string]: unknown;  // REQUIRED for React Flow v12 compat
}
```

Without this, `Node<DagNodeData>[]` won't assign to `Node[]`.

### Lucide Icons Don't Accept `style` Prop

Lucide React icons (v0.400+) don't accept a `style` prop. To apply inline colors, wrap in a `<span>`:

```tsx
// ❌ Won't compile
<Icon size={16} style={{ color }} />

// ✅ Correct
<span style={{ color }}><Icon size={16} /></span>
```

## Session Management

### Session Working Directory Grouping

Sessions are grouped by `working_dir` field in the SQLite database. Key gotchas:

- **72 sessions** had `/tmp/.tmpXXXXXX` as working_dir — each created its own one-session "project" group
- **Fix:** Detect temp dirs via regex (`/^\/tmp\/\.?tmp/`) and group as "General"
- **Empty `working_dir`** (`""`) → groups as "General" (empty string is falsy)
- **Nested subdirs** (e.g., `/home/user/goose4/crates/goose`) showed as "goose" — confusing alongside "goose4"
- **Fix:** When a dir is a subdirectory of another session's dir, show relative path: `goose4 › crates/goose`

### Home Directory Detection

`window.appConfig` only stores Goose-specific config (`GOOSE_WORKING_DIR`, `GOOSE_DEFAULT_PROVIDER`, etc.), **not** general env vars like `HOME`. To detect the home directory:

```typescript
// ❌ Won't work — HOME is not in appConfig
const home = window.appConfig?.get('HOME');

// ✅ Use regex pattern matching
const isHome = /^\/home\/[^/]+$/.test(dir) || /^\/Users\/[^/]+$/.test(dir);
```

### Session Deletion API

`DELETE /sessions/{session_id}` exists in the backend (`SessionStorage::delete_session`) but was **never exposed in any UI** until this session. It performs a transactional delete: messages first, then session record.

## Design System

### Semantic Design Tokens

The Goose design system uses semantic Tailwind tokens defined in CSS variables. The full token set:

| Category | Tokens |
|----------|--------|
| **Text** | `text-text-default`, `text-text-muted`, `text-text-subtle`, `text-text-accent`, `text-text-success`, `text-text-danger`, `text-text-warning`, `text-text-on-accent` |
| **Background** | `bg-background-default`, `bg-background-muted`, `bg-background-app`, `bg-background-elevated`, `bg-background-accent`, `bg-background-success-muted`, `bg-background-danger-muted`, `bg-background-warning-muted` |
| **Border** | `border-border-default`, `border-border-muted`, `border-border-accent`, `border-border-subtle` |

**Never use** hardcoded `dark:` prefixed Tailwind colors — the design system handles light/dark via CSS variables.

### StatCard Variants

The `StatCard` component accepts `variant: 'default' | 'success' | 'warning' | 'danger'` — there is **no `'error'` variant**. Use `'danger'` instead.

## Generative UI

### Spec Detection in Chat Messages

The LLM can embed generative UI specs in messages using two formats:

1. XML tags: `<goose-ui>{"type":"Stack",...}</goose-ui>`
2. Fenced code blocks: `` ```goose-ui\n{"type":"Stack",...}\n``` ``

The `extractGenerativeSpec()` utility handles both, plus partial spec detection during streaming.

### Two Generative UI Systems

There are **two** generative UI systems in the codebase:

1. **Old:** `lib/generative-catalog.ts` + `lib/generative-registry.tsx` — uses `@json-render/core` `defineCatalog`
2. **New:** `components/ui/design-system/goose-renderer.tsx` — uses `@json-render/react` `JSONUIProvider`

The **new** system (`GooseGenerativeUI` + `isGooseUISpec`) is what's wired into `GooseMessage.tsx`. The old system is used by `GenerativePanel.tsx` (standalone panel mode).

### CSP Warning

`@json-render/react` triggers a Content-Security-Policy warning about `eval()` in the Electron dev console. Investigation shows the library uses `evaluateVisibility`/`evaluateCondition` functions that are **safe** (not actual `eval()`). The CSP warning is a false positive — `unsafe-eval` is NOT needed.

## Navigation

### Sidebar Zone Behavior

Multi-item sidebar zones (Workflows, Catalog) need a `route` property to navigate when the zone label is clicked. Without it, clicking the label only toggles the collapsible submenu.

```typescript
// ✅ Label click navigates, chevron toggles collapse
{ id: 'workflows', label: 'Workflows', route: '/recipes', items: [...] }

// ❌ Label click only toggles — confusing UX
{ id: 'workflows', label: 'Workflows', items: [...] }
```

### Route Configuration

The app has 13 routes in `App.tsx` (HashRouter):
- `/` → Hub (index)
- `/pair` → Chat (pair mode, SSE connection kept alive)
- `/settings`, `/extensions`, `/apps`, `/sessions`, `/schedules`, `/recipes`
- `/agents`, `/analytics`, `/monitoring`, `/evaluate`, `/tools`, `/catalogs`
- **`/pipelines`** — New DAG workflow builder (PipelineManager)

## Pipeline System

### File-Based Storage Pattern

Pipelines follow the same storage pattern as recipes:
- Directory: `~/.config/goose/pipelines/`
- Format: YAML files with `.yaml` extension
- ID: filename stem (e.g., `code-review.yaml` → ID `code-review`)
- Manifest: in-memory directory scan (no separate manifest file)

### Validation

Pipeline validation includes **cycle detection via DFS**. The algorithm:
1. Build adjacency list from edges
2. Three-color DFS: White (unvisited), Gray (in current path), Black (fully explored)
3. Gray→Gray edge = cycle detected → validation error

### API Version

Pipelines use `apiVersion: "goose/v1"` and `kind: "Pipeline"` — following Kubernetes-style resource manifests. This is part of the type definition, not enforced at the API level yet.

## Multi-Agent System

### A2A Instance Type Casting

The `InstanceStatus` type from the API sometimes arrives as a plain string from the server. Components must cast explicitly:

```typescript
<InstanceStatusBadge status={instance.status as InstanceStatus} />
```

### Provider/Model API

- `providers()` returns `Array<ProviderDetails>` with `name`, `is_configured`, `metadata`, `provider_type`
- `getProviderModels({ path: { name: providerName } })` returns `Array<string>` (just model name strings)
- Only configured providers should be shown in dropdowns — filter by `is_configured: true`

## React DevTools in Electron 40

`electron-devtools-installer` v4.0.0 **silently fails** with Electron 40+. The fallback strategy:

1. Try `installExtension(REACT_DEVELOPER_TOOLS)` — may silently fail
2. Fall back to loading from local Chromium installation:
   - Linux: `~/.config/chromium/Default/Extensions/fmkadmapgofadopljbjfkapdkoienihi/`
   - macOS: `~/Library/Application Support/Google/Chrome/Default/Extensions/fmkadmapgofadopljbjfkapdkoienihi/`
3. Find the latest version directory, load via `session.defaultSession.loadExtension()`
4. Log warning if neither approach works — dev tools still open via Alt+Cmd+I, just without React tab

## Testing

### No UI Tests Exist

There are **zero** frontend unit tests for the components modified in this session. The `utils.test.ts` (316 lines) in `settings/extensions/` is the only component-level test file. E2E tests via Playwright exist but are infrastructure-focused.

### Backend Pipeline Tests

`crates/goose/src/pipeline.rs` includes 3 unit tests:
- `test_yaml_roundtrip` — serialize/deserialize preserves all fields
- `test_validate_pipeline` — rejects pipelines with no trigger node
- `test_cycle_detection` — detects A→B→C→A cycles

Run with: `cargo test -p goose -- pipeline`

## Session 2 Findings (2026-02-17 evening)

### Radix UI Tooltip Portal Infinite Loop

**Critical bug:** `@radix-ui/react-tooltip`'s `TooltipPrimitive.Portal` causes `Maximum update depth exceeded` when combined with React StrictMode.

**Root cause chain:**
1. React StrictMode double-mounts components
2. Radix Portal uses `composeRefs` to merge multiple refs
3. `composeRefs` calls `setRef` which triggers `setState`
4. `setState` causes re-render → `setRef` called again → infinite loop

**Error signature:**
```
Error: Maximum update depth exceeded
    at setRef (chunk-EYE7376K.js:12:12)
    at chunk-EYE7376K.js:21:23
    at Array.map (<anonymous>)
```

**Fix:** Remove `<TooltipPrimitive.Portal>` wrapper from `TooltipContent` in `src/components/ui/Tooltip.tsx`. Tooltip positioning still works via Radix Popper's CSS transforms.

**Risk:** In rare z-index stacking contexts, non-portaled tooltips might render behind overlapping elements. Monitor for visual issues.

**Affected packages:** `@radix-ui/react-scroll-area@1.2.10`, `react-dialog`, `react-portal` — they share `chunk-EYE7376K.js` in Vite's dependency cache.

### Ripgrep Cannot Search AppSidebar.tsx

`rg` (ripgrep) returns **0 results** for any pattern in `AppSidebar.tsx`, but `grep -c` finds matches correctly. The file is 1082 lines, identified as `JavaScript source` by `file(1)`.

**Workaround:** Use `grep` instead of `rg` for this specific file:
```bash
# rg returns nothing:
rg "handleNewChat" src/components/GooseSidebar/AppSidebar.tsx  # → 0 results

# grep works:
grep -c "handleNewChat" src/components/GooseSidebar/AppSidebar.tsx  # → 4
```

**Likely cause:** File encoding anomaly (possible BOM, mixed line endings, or NUL bytes). Not investigated further.

### Home/Chat Unification Architecture

The old architecture had two separate views:
- `/` → `HubRouteWrapper` → `Hub.tsx` (stats page, dead end)
- `/pair` → `PairRouteWrapper` → `ChatSessionsContainer` → `BaseChat`

**New architecture:**
- `/` → `HomeRedirectWrapper` → `<Navigate to="/pair" replace />`
- `/pair` → `PairRouteWrapper` → `ChatSessionsContainer` → `BaseChat`
  - 0 messages → `WelcomeState` (greeting + quick prompts + stats + recent sessions)
  - ≥1 message → `ProgressiveMessageList` (normal chat)

**Key insight:** `ChatSessionsContainer` stays mounted at all times (keeps SSE connections alive). The session is created lazily when the user types their first message.

### Pipeline Routes Need 3-File Registration (Reinforced)

Adding pipeline routes required editing 3 Rust files simultaneously. **Critical discovery:** When working with a concurrent backend agent, these files get reverted/commented frequently. Each `just generate-openapi` can overwrite if the 3 files aren't consistent.

**Pipeline registration status checklist:**
```bash
# Verify all 3 are active:
grep "pub mod pipeline" crates/goose/src/lib.rs
grep "pub mod pipeline" crates/goose-server/src/routes/mod.rs
grep -c "pipeline" crates/goose-server/src/openapi.rs  # should be 14+
```

### WorkflowsOverview Mirrors CatalogsOverview

Both zone overview pages follow identical patterns:
- `CatalogsOverview.tsx` → `/catalogs` (Agents, Extensions, Apps)
- `WorkflowsOverview.tsx` → `/workflows` (Recipes, Pipelines, Schedules)

Both zones behave identically:
- Label click → overview page
- Sub-items → detail pages
- `route` property on the zone config makes label navigable

### Session Deletion Backend Pre-existed

`DELETE /sessions/{session_id}` was already implemented in the backend (`SessionStorage::delete_session()` with transactional message + session delete). The frontend just needed UI controls:
- Hover trash icon on `SessionItem` for individual delete
- `X` button on project group header for bulk project close
- Both require `window.confirm()` before proceeding

### Project Grouping Edge Cases (278 Real Sessions)

With 278 real sessions in the database:
- **72 temp sessions** (`/tmp/.tmpXXXXXX`) each created their own project group — now grouped into "General"
- **Nested subdirs** (`goose4/crates/goose`) showed as just "goose" — now shows `goose4 › crates/goose`
- **Home dir detection** can't use `window.appConfig` (only has Goose-specific keys) — uses regex: `/^\/home\/[^/]+$/` and `/^\/Users\/[^/]+$/`
- **"General" always first** — sorts before all other projects, always present even with 0 sessions
