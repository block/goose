---
title: "Agent Ã— Mode Architecture"
description: "How Goose separates persona (Agent) from behavior (Mode), aligned with ACP/A2A/Kilo Code"
date: "2025-07-23"
status: "implemented"
tags: ["architecture", "agents", "modes", "acp", "a2a"]
authors: ["goose"]
related:
  - docs/architecture/agent-persona-cleanup.md
  - docs/architecture/extension-agent-separation.md
  - docs/knowledge/protocols-acp-a2a-sota-goose.md
evidence:
  - crates/goose/src/agents/universal_mode.rs
  - crates/goose/src/agents/developer_agent.rs
  - crates/goose/src/agents/routing_eval.rs
---

# Agent Ã— Mode Architecture

## Core Principle

**Agent = WHO (persona/role)**. **Mode = HOW (behavioral stance)**. These are orthogonal dimensions.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent Ã— Mode Matrix                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Agent\Mode   â”‚  Ask   â”‚  Plan  â”‚ Write  â”‚ Review â”‚   Debug     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Developer    â”‚ R/O    â”‚ R/O+md â”‚ Full   â”‚ R/O    â”‚ Full+diag   â”‚
â”‚ QA           â”‚ R/O    â”‚ R/O+md â”‚ Test   â”‚ R/O    â”‚ â€”           â”‚
â”‚ PM           â”‚ R/O    â”‚ R/O+md â”‚ Docs   â”‚ R/O    â”‚ â€”           â”‚
â”‚ Security     â”‚ R/O    â”‚ R/O+md â”‚ Sec    â”‚ R/O    â”‚ â€”           â”‚
â”‚ Research     â”‚ R/O    â”‚ R/O+md â”‚ Docs   â”‚ R/O    â”‚ â€”           â”‚
â”‚ Goose        â”‚ catch-all conversational agent                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Protocol Alignment

| Concept | ACP | A2A | Kilo Code | Goose |
|---------|-----|-----|-----------|-------|
| Persona | `AgentManifest` | `AgentCard` | Agent | `*Agent` struct |
| Behavior | `SessionMode` | â€” | `customMode` | `UniversalMode` enum |
| Capability | â€” | `AgentSkill` | â€” | `AgentSkill` (future) |

## Universal Modes

| Mode | Slug | Stance | Tool Access | Output |
|------|------|--------|-------------|--------|
| ğŸ” Ask | `ask` | Read-only exploration | read, fetch, memory | Explanations, citations |
| ğŸ“ Plan | `plan` | Design without writing | read, fetch, memory | Plans, diagrams, ADRs |
| âœï¸ Write | `write` | Produce deliverables | Full per-agent | Code, docs, configs |
| ğŸ” Review | `review` | Evaluate without modifying | read, command (test/lint) | Findings, verdicts |
| ğŸ› Debug | `debug` | Diagnose and fix | Full + diagnostics | Root cause + fix |

## Implementation

### Key Files

| File | Purpose |
|------|---------|
| `crates/goose/src/agents/universal_mode.rs` | `UniversalMode` enum with 5 variants |
| `crates/goose/src/agents/developer_agent.rs` | Developer persona with universal modes |
| `crates/goose/src/agents/qa_agent.rs` | QA persona with 4 universal modes |
| `crates/goose/src/agents/pm_agent.rs` | PM persona with 4 universal modes |
| `crates/goose/src/agents/security_agent.rs` | Security persona with 4 universal modes |
| `crates/goose/src/agents/research_agent.rs` | Research persona with 4 universal modes |
| `crates/goose/src/agents/intent_router.rs` | AgentÃ—Mode routing with description bonus |
| `crates/goose/src/agents/routing_eval.rs` | 50-case routing accuracy test matrix |

### Prompt Template Structure (7 sections)

Each prompt template follows:

1. **Identity** â€” Who the agent is (persona declaration)
2. **Expertise** â€” Domain knowledge areas
3. **Mode Behavior** â€” What this mode does and doesn't do
4. **Tools** â€” Which tools to use and avoid
5. **Approach** â€” Step-by-step methodology
6. **Boundaries** â€” Negative constraints (what NOT to do)
7. **Communication** â€” Output format and style

Templates live at: `crates/goose/src/prompts/{agent_name}/{mode_slug}.md`

## Routing

Two-tier routing strategy:

1. **Fast-path**: Keyword router scores agent descriptions + mode keywords
2. **LLM fallback**: Orchestrator uses `splitting.md` prompt for complex routing

Keyword router baseline: **42% agent accuracy** (expected for fast-path).
The LLM orchestrator handles the remaining cases.

## SOTA Sources

- [Kilo Code Custom Modes](https://kilo.ai/docs/customize/custom-modes) â€” YAML schema for modes
- [Cursor Agent Modes](https://cursor.com/docs/agent/modes) â€” Ask/Agent/Manual distinction
- [GitHub Copilot Prompt Structure](https://dev.to/seiwan-maikuma/a-deep-dive-into-github-copilot-agent-modes-prompt-structure-2i4g) â€” 3-layer prompt architecture
- [Anthropic Building Effective Agents](https://www.anthropic.com/research/building-effective-agents) â€” Orchestrator-workers pattern
- [ACP SessionMode](https://docs.rs/agent-client-protocol/latest/agent_client_protocol/struct.SessionMode.html) â€” Protocol struct
- [A2A Protocol](https://github.com/a2aproject/A2A) â€” AgentCard + AgentSkill model

## Open Work

1. **Enable DeveloperAgent** â€” flip `enabled: true` in intent_router, deprecate CodingAgent
2. **GooseAgent refactor** â€” split into proper universal modes (currently legacy)
3. **LLM-based routing** â€” replace keyword scorer with LLM classification
4. **Extension-Agent separation** â€” shared ExtensionRegistry (see `extension-agent-separation.md`)
