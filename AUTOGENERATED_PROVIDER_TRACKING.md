# Autogenerated Provider Tracking

## Overview

Added support for tracking which custom providers were auto-generated from the catalog vs. manually created. This allows us to update/fix catalog-based providers when the canonical models change.

## Changes Made

### Backend (Rust)

#### 1. Updated DeclarativeProviderConfig (`crates/goose/src/config/declarative_providers.rs`)

Added two new fields:
```rust
pub struct DeclarativeProviderConfig {
    // ... existing fields ...

    #[serde(default)]
    pub autogenerated: bool,           // NEW: Tracks if provider was created from catalog

    #[serde(default)]
    pub catalog_provider_id: Option<String>,  // NEW: Stores models.dev provider ID
}
```

**Purpose:**
- `autogenerated`: Boolean flag indicating the provider was created using the catalog wizard
- `catalog_provider_id`: Stores the original provider ID from models.dev (e.g., "groq", "deepseek")

**Benefits:**
- Can identify which providers came from the catalog
- Can update autogenerated providers when models.dev data changes
- Can offer "refresh from catalog" option for outdated providers
- Preserve manual customizations for non-autogenerated providers

#### 2. Updated CreateCustomProviderParams & UpdateCustomProviderParams

Both structs now include:
```rust
pub autogenerated: bool,
pub catalog_provider_id: Option<String>,
```

#### 3. Updated create_custom_provider() and update_custom_provider()

Both functions now:
- Accept the new fields in their params
- Store them in the provider config JSON
- Preserve the values during updates

#### 4. Updated UpdateCustomProviderRequest (API type)

API request now accepts:
```rust
#[derive(Deserialize, ToSchema)]
pub struct UpdateCustomProviderRequest {
    // ... existing fields ...

    #[serde(default)]
    pub autogenerated: bool,

    #[serde(default)]
    pub catalog_provider_id: Option<String>,
}
```

### Frontend (React/TypeScript)

#### 1. Updated EnhancedCustomProviderForm

Automatically sets autogenerated flag when using a template:
```tsx
onSubmit({
  // ... other fields ...
  autogenerated: !!template,           // true if using catalog template
  catalog_provider_id: template?.id,    // e.g., "groq"
});
```

#### 2. Updated CustomProviderForm

Explicitly sets autogenerated to false for manual setups:
```tsx
onSubmit({
  // ... other fields ...
  autogenerated: false,
  catalog_provider_id: undefined,
});
```

#### 3. Updated ProviderGrid

**Now shows TWO add cards:**

1. **"Other Providers" Card** (catalog-based)
   - Blue background, search icon
   - Opens catalog wizard
   - Shows "80+ providers"
   - Sets `autogenerated: true`

2. **"Manual Setup" Card** (traditional)
   - Dashed border, plus icon
   - Opens traditional form
   - Sets `autogenerated: false`

**Smart editing:**
- Autogenerated providers → Opens catalog wizard (can refresh models)
- Manual providers → Opens traditional form (preserves custom config)

#### 4. Created AddProviderCards Component

New component with two card variants:
- `OtherProvidersCard` - For catalog-based providers
- `ManualProviderCard` - For manual setup

## Data Flow

### Creating Catalog-Based Provider

```
User clicks "Other Providers" card
  ↓
Opens CustomProviderWizard
  ↓
User selects provider from catalog (e.g., "Groq")
  ↓
EnhancedCustomProviderForm pre-fills with template
  ↓
User enters API key
  ↓
Form submits with:
  - autogenerated: true
  - catalog_provider_id: "groq"
  - models: ["llama-3.1-8b-instant", ...]
  ↓
Backend saves to custom_groq.json:
{
  "name": "custom_groq",
  "display_name": "Groq",
  "autogenerated": true,
  "catalog_provider_id": "groq",
  "models": [...]
}
```

### Creating Manual Provider

```
User clicks "Manual Setup" card
  ↓
Opens CustomProviderForm (traditional)
  ↓
User enters all details manually
  ↓
Form submits with:
  - autogenerated: false
  - catalog_provider_id: undefined
  ↓
Backend saves with autogenerated: false
```

### Editing Providers

```
User clicks "Configure" on existing provider
  ↓
Backend loads provider config
  ↓
Check autogenerated field:

  If autogenerated: true
    ↓
    Opens CustomProviderWizard
    Shows catalog-based editing flow
    Can refresh models from catalog

  If autogenerated: false
    ↓
    Opens CustomProviderForm
    Shows manual editing flow
    Preserves custom configuration
```

## Use Cases

### 1. Updating Models When Catalog Changes

**Scenario:** models.dev adds new models for Groq

**Solution:**
```rust
// Find all autogenerated Groq providers
let providers = find_autogenerated_providers("groq");

for provider in providers {
    // Fetch latest models from catalog
    let latest_template = get_provider_template("groq")?;

    // Merge with user's existing selection
    let updated_models = merge_models(
        provider.models,
        latest_template.models,
    );

    // Update provider config
    update_provider_models(provider.id, updated_models)?;
}
```

### 2. Migration/Upgrade Prompts

**Scenario:** User has old manually-created "Groq" provider, catalog now has official one

**Solution:**
```rust
// Detect manual provider that matches catalog
if !provider.autogenerated && catalog_has(provider.display_name) {
    show_migration_prompt(
        "Groq is now available in the catalog. Migrate to get automatic updates?"
    );
}
```

### 3. Bulk Updates

**Scenario:** models.dev API changes, need to update all catalog providers

**Solution:**
```rust
// Update all autogenerated providers
let autogen_providers = providers.filter(|p| p.autogenerated);

for provider in autogen_providers {
    if let Some(catalog_id) = provider.catalog_provider_id {
        refresh_from_catalog(provider.id, catalog_id)?;
    }
}
```

### 4. User Protection

**Scenario:** User manually customized an autogenerated provider

**Solution:**
```rust
// When updating from catalog, check for customizations
if provider.autogenerated {
    let catalog_template = get_provider_template(&provider.catalog_provider_id)?;

    if has_custom_models(provider, catalog_template) {
        warn_user("You have custom models. Updating will reset them.");
    }
}
```

## Database Schema (JSON files)

### Autogenerated Provider Example
```json
{
  "name": "custom_groq",
  "engine": "openai",
  "display_name": "Groq",
  "description": "Custom Groq provider",
  "api_key_env": "CUSTOM_GROQ_API_KEY",
  "base_url": "https://api.groq.com/openai/v1/chat/completions",
  "autogenerated": true,
  "catalog_provider_id": "groq",
  "models": [
    {
      "name": "llama-3.1-8b-instant",
      "context_limit": 131072
    }
  ],
  "supports_streaming": true
}
```

### Manual Provider Example
```json
{
  "name": "custom_my_provider",
  "engine": "openai",
  "display_name": "My Provider",
  "description": "Custom My Provider provider",
  "api_key_env": "CUSTOM_MY_PROVIDER_API_KEY",
  "base_url": "https://my-custom-api.com/v1/chat",
  "autogenerated": false,
  "catalog_provider_id": null,
  "models": [
    {
      "name": "custom-model-1",
      "context_limit": 8000
    }
  ],
  "supports_streaming": true
}
```

## UI Indicators (Future Enhancement)

Could add visual indicators for autogenerated providers:

```tsx
<ProviderCard
  provider={provider}
  badge={
    provider.config.autogenerated && (
      <Badge>
        <Sparkles className="w-3 h-3" />
        Auto-updated
      </Badge>
    )
  }
/>
```

## Migration Path

### For Existing Providers (all will be marked as manual)

```rust
// During first load after upgrade
for provider in existing_providers {
    if !provider.has_field("autogenerated") {
        provider.autogenerated = false;  // Default to manual
        provider.catalog_provider_id = None;
        save_provider(provider);
    }
}
```

### For Users

- Existing custom providers: Continue working, marked as manual
- New catalog providers: Auto-marked as autogenerated
- Users can recreate old custom providers from catalog to get auto-updates

## API Examples

### Check if Provider is Autogenerated
```rust
let provider = load_provider("custom_groq")?;
if provider.config.autogenerated {
    println!("This provider can be refreshed from catalog");
}
```

### Get Catalog Provider ID
```rust
if let Some(catalog_id) = provider.config.catalog_provider_id {
    let latest = get_provider_template(&catalog_id)?;
    // Compare with current config
}
```

### Refresh from Catalog
```rust
pub fn refresh_provider_from_catalog(provider_id: &str) -> Result<()> {
    let provider = load_provider(provider_id)?;

    if !provider.config.autogenerated {
        return Err(anyhow!("Cannot refresh manual provider from catalog"));
    }

    let catalog_id = provider.config.catalog_provider_id
        .ok_or(anyhow!("Missing catalog_provider_id"))?;

    let template = get_provider_template(&catalog_id)?;

    // Update models while preserving user's API key
    update_custom_provider(UpdateCustomProviderParams {
        id: provider_id.to_string(),
        models: template.models.iter().map(|m| m.id.clone()).collect(),
        api_key: String::new(), // Keep existing
        // ... other fields from template
        autogenerated: true,
        catalog_provider_id: Some(catalog_id),
    })?;

    Ok(())
}
```

## Benefits Summary

✅ **Track Origin** - Know which providers came from catalog vs. manual
✅ **Safe Updates** - Only update autogenerated providers when catalog changes
✅ **User Choice** - Users can still do manual setup if they prefer
✅ **Future-Proof** - Can add "refresh from catalog" button for autogenerated providers
✅ **Migration Support** - Can detect and offer to migrate manual → autogenerated
✅ **Audit Trail** - Can track which catalog provider was used
✅ **Selective Updates** - Only apply catalog changes to providers that want them
