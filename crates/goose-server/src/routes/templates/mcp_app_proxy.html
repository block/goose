<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="referrer" content="no-referrer"/>
    <title>MCP App Sandbox</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
      iframe {
        width: 100%;
        height: 100%;
        border: none;
      }
    </style>
  </head>
  <body>
    <script>
      (function () {
        'use strict';

        let guestIframe = null;
        const contentUrl = '{{CONTENT_URL}}';
        const permissions = {{PERMISSIONS_JSON}};

        function createGuestIframe() {
          if (guestIframe) {
            guestIframe.remove();
          }

          guestIframe = document.createElement('iframe');

          // Sandbox permissions for the Guest UI
          // allow-scripts: needed for the app to run
          // allow-same-origin: needed for localStorage, cookies, etc.
          // allow-forms: needed if the app has forms
          guestIframe.setAttribute('sandbox', 'allow-scripts allow-same-origin allow-forms');

          // Build Permission Policy allow attribute from requested permissions
          // These control access to sensitive browser APIs like camera, microphone, etc.
          var allowList = [];
          if (permissions && permissions.camera) allowList.push('camera');
          if (permissions && permissions.microphone) allowList.push('microphone');
          if (permissions && permissions.geolocation) allowList.push('geolocation');
          if (permissions && permissions.clipboardWrite) allowList.push('clipboard-write');
          if (allowList.length > 0) {
            guestIframe.setAttribute('allow', allowList.join('; '));
          }

          // Use src instead of srcdoc - loads from real URL for secure context
          guestIframe.src = contentUrl;
          guestIframe.style.cssText = 'width:100%; height:100%; border:none;';

          document
            .body
            .appendChild(guestIframe);
        }

        /**
         * Handle messages from the Host (parent window).
         */
        function handleHostMessage(event) {
          if (event.source !== window.parent) {
            return;
          }

          var data = event.data;
          if (!data || typeof data !== 'object') {
            return;
          }

          // Forward all messages to Guest UI (if it exists)
          // This includes lifecycle messages like responses to ui/initialize
          if (guestIframe && guestIframe.contentWindow) {
            guestIframe
              .contentWindow
              .postMessage(data, '*');
          }
        }

        /**
         * Handle messages from the Guest UI (inner iframe).
         */
        function handleGuestMessage(event) {
          if (!guestIframe || event.source !== guestIframe.contentWindow) {
            return;
          }

          var data = event.data;
          if (!data || typeof data !== 'object') {
            return;
          }

          // Forward all messages from Guest UI to Host
          // The Sandbox does NOT create its own requests - just relays
          window
            .parent
            .postMessage(data, '*');
        }

        /**
         * Main message handler - routes to appropriate handler.
         */
        function handleMessage(event) {
          if (event.source === window.parent) {
            handleHostMessage(event);
          } else if (guestIframe && event.source === guestIframe.contentWindow) {
            handleGuestMessage(event);
          }
        }

        // Set up message listener
        window.addEventListener('message', handleMessage);

        // Create the guest iframe immediately (content URL and permissions are embedded)
        // Note: Unlike web hosts that use sandbox-proxy-ready/sandbox-resource-ready handshake,
        // we embed the content URL directly since this is for Electron (desktop) which needs
        // secure context but can trust the content source.
        createGuestIframe();
      })();
    </script>
  </body>
</html>
