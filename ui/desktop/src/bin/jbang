#!/bin/bash

# Source common functions
source "$(dirname "$0")/lib/shim.sh"

log "Starting jbang setup script."

setup_directories
setup_hermit

# Install OpenJDK using hermit
log "Installing OpenJDK with hermit."
hermit install openjdk@17 >> "$LOG_FILE"

# Download and install jbang if not present
if [ ! -f ~/.config/goose/mcp-hermit/bin/jbang ]; then
    log "Downloading and installing jbang."
    curl -Ls https://sh.jbang.dev | bash -s - app setup
    cp ~/.jbang/bin/jbang ~/.config/goose/mcp-hermit/bin/
fi

# Verify installations
verify_binary "hermit"
verify_binary "java"
verify_binary "jbang"

# Check for custom registry settings
if [ -n "${GOOSE_JBANG_REGISTRY:-}" ] && check_url_accessible "$GOOSE_JBANG_REGISTRY"; then
    log "Setting custom registry: $GOOSE_JBANG_REGISTRY"
    export JBANG_REPO="$GOOSE_JBANG_REGISTRY"
else
    log "Using default jbang repository."
fi

# Trust all jbang scripts
jbang --quiet trust add *

# Execute jbang
log "Executing 'jbang' command with arguments: $*"
jbang --fresh --quiet "$@" || log "Failed to execute 'jbang' with arguments: $*"

log "jbang setup script completed successfully."
