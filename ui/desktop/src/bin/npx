#!/bin/bash

# Source common functions
source "$(dirname "$0")/lib/shim.sh"

log "Starting npx setup script."

setup_directories
setup_hermit

# Install Node.js using hermit
log "Installing Node.js with hermit."
hermit install node >> "$LOG_FILE"

# Verify installations
verify_binary "hermit"
verify_binary "node"
verify_binary "npx"

# Setup custom registry if available
if [ -n "${GOOSE_NPM_REGISTRY:-}" ] && check_url_accessible "$GOOSE_NPM_REGISTRY"; then
    log "Setting custom registry: $GOOSE_NPM_REGISTRY"
    export NPM_CONFIG_REGISTRY="$GOOSE_NPM_REGISTRY"

    if [ -n "${GOOSE_NPM_CERT:-}" ] && check_url_accessible "$GOOSE_NPM_CERT"; then
        log "Downloading certificate from: $GOOSE_NPM_CERT"
        curl -sSL -o ~/.config/goose/mcp-hermit/cert.pem "$GOOSE_NPM_CERT"
        export NODE_EXTRA_CA_CERTS=~/.config/goose/mcp-hermit/cert.pem
    fi
else
    export NPM_CONFIG_REGISTRY="https://registry.npmjs.org/"
fi

# Execute npx
log "Executing 'npx' command with arguments: $*"
npx "$@" || log "Failed to execute 'npx' with arguments: $*"

log "npx setup script completed successfully."
