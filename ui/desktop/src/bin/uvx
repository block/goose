#!/bin/bash

# Source common functions
source "$(dirname "$0")/lib/shim.sh"

log "Starting uvx setup script."

setup_directories
setup_hermit

# Initialize python
log "Installing Python 3.10 with hermit"
hermit install python3@3.10 >> "$LOG_FILE"

# Install UV using hermit
log "Installing UV with hermit."
hermit install uv >> "$LOG_FILE"

# Verify installations
verify_binary "hermit"
verify_binary "uv"
verify_binary "uvx"

# Setup custom registry if available
if [ -n "${GOOSE_UV_REGISTRY:-}" ] && check_url_accessible "$GOOSE_UV_REGISTRY"; then
    log "Setting custom registry: $GOOSE_UV_REGISTRY"
    export UV_INDEX_URL="$GOOSE_UV_REGISTRY"
    export UV_NATIVE_TLS=true
fi

# Execute uvx
log "Executing 'uvx' command with arguments: $*"
uvx "$@" || log "Failed to execute 'uvx' with arguments: $*"

log "uvx setup script completed successfully."
