<!doctype html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' http://127.0.0.1:* https:; object-src 'none'; font-src 'self' data: https:; media-src 'self' mediastream:; form-action 'none'; base-uri 'self'; manifest-src 'self'; worker-src 'self'; frame-src 'self' https: http:;"/>
    <title>Goose</title>
    <script>
      // Initialize theme before any content loads
      (function () {
        function initializeTheme() {
          try {
            if (window.localStorage) {
              const useSystemTheme = localStorage.getItem('use_system_theme') === 'true';
              const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              const savedTheme = localStorage.getItem('theme');
              
              const isDark = useSystemTheme ? systemPrefersDark : (savedTheme ? savedTheme === 'dark' : systemPrefersDark);
              
              if (isDark) {
                document.documentElement.classList.add('dark');
              } else {
                document.documentElement.classList.remove('dark');
              }

              // Apply custom theme colors if enabled
              const customThemeEnabled = localStorage.getItem('custom_theme_enabled') === 'true';
              if (customThemeEnabled) {
                let customColor = localStorage.getItem('custom_theme_color') || '#32353b';
                // Validate the color before applying it
                if (!hexToRgb(customColor)) {
                  customColor = '#32353b';
                }
                applyCustomThemeColors(customColor, isDark);
              }
            } else {
              const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
              if (systemPrefersDark) {
                document.documentElement.classList.add('dark');
              }
            }
          } catch (error) {
            console.warn('Failed to initialize theme from localStorage, using system preference:', error);
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (systemPrefersDark) {
              document.documentElement.classList.add('dark');
            }
          }
        }

        // Inline color utilities for initial theme application
        function hexToRgb(hex) {
          const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
          } : null;
        }

        function rgbToHsl(r, g, b) {
          r /= 255; g /= 255; b /= 255;
          const max = Math.max(r, g, b), min = Math.min(r, g, b);
          let h = 0, s = 0, l = (max + min) / 2;
          if (max !== min) {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
              case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
              case g: h = ((b - r) / d + 2) / 6; break;
              case b: h = ((r - g) / d + 4) / 6; break;
            }
          }
          return { h: h * 360, s: s * 100, l: l * 100 };
        }

        function hslToRgb(h, s, l) {
          h /= 360; s /= 100; l /= 100;
          let r, g, b;
          if (s === 0) {
            r = g = b = l;
          } else {
            const hue2rgb = (p, q, t) => {
              if (t < 0) t += 1;
              if (t > 1) t -= 1;
              if (t < 1/6) return p + (q - p) * 6 * t; // Hue in red-yellow range
              if (t < 1/2) return q; // Hue in yellow-cyan range
              if (t < 2/3) return p + (q - p) * (2/3 - t) * 6; // Hue in cyan-blue range
              return p;
            };
            const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
            const p = 2 * l - q;
            r = hue2rgb(p, q, h + 1/3);
            g = hue2rgb(p, q, h);
            b = hue2rgb(p, q, h - 1/3);
          }
          return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
        }

        function rgbToHex(r, g, b) {
          return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
        }

        function applyCustomThemeColors(baseColor, isDark) {
          const rgb = hexToRgb(baseColor);
          if (!rgb) return;
          
          const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
          const root = document.documentElement;
          const saturation = Math.min(hsl.s * 0.15, 10);
          
          // Generate and apply neutral colors
          const lightnesses = { 50: 97, 100: 93, 200: 85, 300: 70, 400: 55, 500: 45, 600: 35, 700: 28, 800: 22, 900: 16, 950: 10 };
          Object.entries(lightnesses).forEach(([key, lightness]) => {
            const neutralRgb = hslToRgb(hsl.h, saturation, lightness);
            root.style.setProperty('--color-neutral-' + key, rgbToHex(neutralRgb.r, neutralRgb.g, neutralRgb.b));
          });
          
          // Apply accent color
          const accentRgb = isDark 
            ? hslToRgb(hsl.h, Math.min(hsl.s, 80), Math.min(hsl.l + 20, 85))
            : hslToRgb(hsl.h, Math.min(hsl.s + 10, 90), Math.max(hsl.l - 15, 25));
          root.style.setProperty('--color-accent', rgbToHex(accentRgb.r, accentRgb.g, accentRgb.b));
        }

        // Run immediately
        initializeTheme();
        
        // Retry after DOM is ready if initial attempt failed
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeTheme, 50);
          });
        }
      })();
    </script>
    <link href="./src/styles/main.css" rel="stylesheet"/>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="./src/renderer.tsx"></script>
  </body>
</html>